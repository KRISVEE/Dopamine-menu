<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dopamine Menu</title>
    
    <!-- 1. Load Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Load Babel (To translate the code in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Load Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* Custom animation for spinning */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-custom { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION LOGIC ---
        let firebaseConfig;
        let isConfigured = false;

        // 1. Try to use the Preview Environment keys (so it works here in the chat)
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            isConfigured = true;
        } else {
            // 2. Fallback to manual keys for Local Use
            // YOU MUST REPLACE THESE VALUES WHEN RUNNING ON YOUR COMPUTER
            firebaseConfig = {
                apiKey: "PASTE_API_KEY_HERE",
                authDomain: "PASTE_AUTH_DOMAIN_HERE",
                projectId: "PASTE_PROJECT_ID_HERE",
                storageBucket: "PASTE_STORAGE_BUCKET_HERE",
                messagingSenderId: "PASTE_SENDER_ID_HERE",
                appId: "PASTE_APP_ID_HERE"
            };
            
            // Check if user has actually replaced the keys
            if (firebaseConfig.apiKey !== "PASTE_API_KEY_HERE") {
                isConfigured = true;
            }
        }

        // Only initialize if configured, otherwise we show the setup screen
        if (isConfigured) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
            } catch (e) {
                console.error("Firebase Init Error:", e);
                isConfigured = false; // Fallback to error screen if init fails
            }
        }

        const auth = isConfigured ? firebase.auth() : null;
        const db = isConfigured ? firebase.firestore() : null;
        // Use environment app ID if available, otherwise default
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dopamine-menu-lite';

        const { useState, useEffect } = React;

        // --- SETUP INSTRUCTION SCREEN ---
        const SetupScreen = () => (
            <div className="min-h-screen flex items-center justify-center p-4 bg-gray-100">
                <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full">
                    <h1 className="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è Configuration Needed</h1>
                    <p className="mb-4 text-gray-700">The app is running, but it doesn't have your database keys yet.</p>
                    <ol className="list-decimal list-inside space-y-2 text-sm text-gray-600 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <li>Open this <code>index.html</code> file in a text editor (like Notepad or VS Code).</li>
                        <li>Scroll down to the <code>firebaseConfig</code> section.</li>
                        <li>Replace <code>PASTE_API_KEY_HERE</code> (and others) with your actual keys from the Firebase Console.</li>
                        <li>Save and refresh this page.</li>
                    </ol>
                    <div className="mt-6 text-center">
                        <a href="https://console.firebase.google.com" target="_blank" className="text-indigo-600 hover:underline">Go to Firebase Console &rarr;</a>
                    </div>
                </div>
            </div>
        );

        const DopamineMenu = () => {
            if (!isConfigured) return <SetupScreen />;

            const defaultMenu = {
                appetizers: [
                    { id: 1, text: 'Drink a glass of water', icon: 'üíß' },
                    { id: 2, text: 'Do 10 jumping jacks', icon: 'üèÉ' },
                    { id: 3, text: 'Pet the dog/cat', icon: 'üêï' },
                    { id: 4, text: 'Put on "Hype" playlist', icon: 'üéµ' },
                    { id: 5, text: 'Text a friend back', icon: 'üì±' },
                ],
                entrees: [
                    { id: 6, text: 'Work on coding project', icon: 'üíª' },
                    { id: 7, text: 'Go for a run/gym', icon: 'üí™' },
                    { id: 8, text: 'Write/Journaling', icon: '‚úçÔ∏è' },
                    { id: 9, text: 'Deep clean a room', icon: 'üßπ' },
                ],
                sides: [
                    { id: 10, text: 'Fold laundry (w/ Podcast)', icon: 'üëï' },
                    { id: 11, text: 'Clear email inbox', icon: 'üìß' },
                    { id: 12, text: 'Plan tomorrow', icon: 'üìÖ' },
                    { id: 13, text: 'Water the plants', icon: 'ü™¥' },
                ],
                desserts: [
                    { id: 14, text: 'Scroll TikTok (15 min timer)', icon: 'üì±' },
                    { id: 15, text: 'Watch one episode', icon: 'üì∫' },
                    { id: 16, text: 'Play video games', icon: 'üéÆ' },
                    { id: 17, text: 'Sweet treat', icon: 'üç´' },
                ],
            };

            const [menu, setMenu] = useState(defaultMenu);
            const [newItem, setNewItem] = useState('');
            const [activeCategory, setActiveCategory] = useState('appetizers');
            const [randomPick, setRandomPick] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            
            // Sync State
            const [user, setUser] = useState(null);
            const [syncCode, setSyncCode] = useState(() => localStorage.getItem('dopamine_sync_code') || Math.random().toString(36).substring(2, 8).toUpperCase());
            const [isSyncModalOpen, setIsSyncModalOpen] = useState(false);
            const [inputSyncCode, setInputSyncCode] = useState('');
            const [status, setStatus] = useState('offline');

            // Auth
            useEffect(() => {
                // Handle different auth types based on environment
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                         await auth.signInAnonymously();
                    }
                };
                
                initAuth().catch(e => console.error("Auth Failed:", e));
                return auth.onAuthStateChanged(setUser);
            }, []);

            // Sync
            useEffect(() => {
                if (!user || !syncCode) return;
                localStorage.setItem('dopamine_sync_code', syncCode);
                const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('dopamine_menus').doc(syncCode);
                
                setStatus('syncing');
                const unsubscribe = docRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) {
                        setMenu(docSnap.data().menu);
                        setStatus('saved');
                    } else {
                        docRef.set({ menu: menu, createdAt: new Date() }, { merge: true });
                        setStatus('saved');
                    }
                }, (error) => {
                    console.error("Sync Error:", error);
                    setStatus('error');
                });
                return () => unsubscribe();
            }, [user, syncCode]);

            const saveMenu = async (newMenu) => {
                setMenu(newMenu);
                if (!user || !syncCode) return;
                setStatus('syncing');
                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('dopamine_menus').doc(syncCode);
                    await docRef.set({ menu: newMenu, updatedAt: new Date() }, { merge: true });
                    setStatus('saved');
                } catch (e) {
                    console.error("Save Error:", e);
                    setStatus('error');
                }
            };

            const handleAddItem = (e) => {
                e.preventDefault();
                if (!newItem.trim()) return;
                const item = { id: Date.now(), text: newItem, icon: '‚ú®' };
                saveMenu({ ...menu, [activeCategory]: [...menu[activeCategory], item] });
                setNewItem('');
            };

            const handleDelete = (id) => {
                saveMenu({ ...menu, [activeCategory]: menu[activeCategory].filter(i => i.id !== id) });
            };

            const pickRandom = () => {
                setIsSpinning(true);
                setRandomPick(null);
                let count = 0;
                const items = menu[activeCategory];
                if (items.length === 0) { setIsSpinning(false); return; }
                const interval = setInterval(() => {
                    setRandomPick(items[Math.floor(Math.random() * items.length)]);
                    count++;
                    if (count > 10) { clearInterval(interval); setIsSpinning(false); }
                }, 100);
            };

            const handleSyncChange = () => {
                if (inputSyncCode && window.confirm(`Load menu ${inputSyncCode}?`)) {
                    setSyncCode(inputSyncCode);
                    setIsSyncModalOpen(false);
                    setInputSyncCode('');
                }
            };

            const copyToClipboard = () => {
                // Fallback for older browsers or non-secure contexts if navigator.clipboard fails
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(syncCode);
                } else {
                    // Manual copy method
                    const textArea = document.createElement("textarea");
                    textArea.value = syncCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textArea);
                }
                alert("Code copied!");
            };

            const categories = {
                appetizers: { title: 'Appetizers', color: 'bg-yellow-100 text-yellow-800 border-yellow-400', icon: '‚ö°' },
                entrees: { title: 'Entr√©es', color: 'bg-green-100 text-green-800 border-green-400', icon: 'üçΩÔ∏è' },
                sides: { title: 'Sides', color: 'bg-blue-100 text-blue-800 border-blue-400', icon: 'ü•ó' },
                desserts: { title: 'Desserts', color: 'bg-pink-100 text-pink-800 border-pink-400', icon: 'üç∞' },
            };

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <div className="bg-white border-b px-4 py-3 sticky top-0 z-20 flex justify-between items-center shadow-sm">
                        <h1 className="font-bold text-lg">üß† Dopamine Menu</h1>
                        <div className="flex gap-2">
                            <span className={`px-2 py-1 text-xs rounded-full flex items-center ${status === 'saved' ? 'bg-green-100 text-green-600' : status === 'error' ? 'bg-red-100 text-red-600' : 'bg-yellow-100 text-yellow-600'}`}>
                                {status === 'saved' ? 'Synced' : status}
                            </span>
                            <button onClick={() => setIsSyncModalOpen(true)} className="p-2 bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 transition-colors">‚òÅÔ∏è</button>
                        </div>
                    </div>

                    <div className="max-w-2xl mx-auto p-4">
                        {/* Tabs */}
                        <div className="grid grid-cols-4 gap-2 mb-6">
                            {Object.entries(categories).map(([key, info]) => (
                                <button key={key} onClick={() => { setActiveCategory(key); setRandomPick(null); }}
                                    className={`p-2 rounded-xl border-2 flex flex-col items-center justify-center text-xs sm:text-sm font-bold transition-all
                                    ${activeCategory === key ? info.color + ' shadow-md scale-105' : 'bg-white border-gray-100 text-gray-400'}`}>
                                    <span className="text-xl mb-1">{info.icon}</span>
                                    {info.title}
                                </button>
                            ))}
                        </div>

                        {/* Main Card */}
                        <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                            <div className={`px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-opacity-20 ${categories[activeCategory].color.split(' ')[0]}`}>
                                <h2 className="text-xl font-bold">{categories[activeCategory].title}</h2>
                                <button onClick={pickRandom} disabled={isSpinning} className="px-4 py-2 bg-slate-900 text-white rounded-full font-bold shadow-lg active:scale-95 transition-transform">
                                    {isSpinning ? 'üé≤ ...' : 'üé≤ Pick'}
                                </button>
                            </div>

                            {randomPick && (
                                <div className="bg-indigo-600 text-white p-6 text-center animate-in fade-in zoom-in duration-300">
                                    <div className="text-4xl mb-2">{randomPick.icon}</div>
                                    <div className="text-2xl font-bold">{randomPick.text}</div>
                                </div>
                            )}

                            <div className="divide-y divide-gray-50">
                                {menu[activeCategory].map((item) => (
                                    <div key={item.id} className="flex justify-between p-4 hover:bg-gray-50 transition-colors">
                                        <div className="flex gap-3 items-center">
                                            <span className="text-xl">{item.icon}</span>
                                            <span className="font-medium text-slate-700">{item.text}</span>
                                        </div>
                                        <button onClick={() => handleDelete(item.id)} className="text-gray-300 hover:text-red-500 transition-colors">üóëÔ∏è</button>
                                    </div>
                                ))}
                            </div>

                            <form onSubmit={handleAddItem} className="p-4 bg-gray-50 border-t flex gap-2">
                                <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Add new item..." className="flex-1 px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                <button type="submit" className="px-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors">+</button>
                            </form>
                        </div>
                    </div>

                    {/* Sync Modal */}
                    {isSyncModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative shadow-2xl animate-in zoom-in-95 duration-200">
                                <button onClick={() => setIsSyncModalOpen(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2"><span className="text-indigo-600">‚òÅÔ∏è</span> Sync Devices</h3>
                                
                                <div className="bg-indigo-50 p-4 rounded-xl mb-4 text-center border border-indigo-100">
                                    <div className="text-xs text-indigo-400 font-bold uppercase mb-1">Your Unique Code</div>
                                    <div className="text-3xl font-mono font-bold text-indigo-900 tracking-wider mb-2">{syncCode}</div>
                                    <button onClick={copyToClipboard} className="text-xs text-indigo-600 hover:underline font-medium">Click to Copy</button>
                                </div>
                                
                                <div className="space-y-2">
                                    <p className="text-xs text-gray-500 font-medium ml-1">Load from another device:</p>
                                    <div className="flex gap-2">
                                        <input value={inputSyncCode} onChange={e => setInputSyncCode(e.target.value.toUpperCase())} placeholder="ENTER CODE" className="flex-1 px-4 py-2 border rounded-lg uppercase focus:ring-2 focus:ring-indigo-500 outline-none" />
                                        <button onClick={handleSyncChange} className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-700 transition-colors">Load</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DopamineMenu />);
    </script>
</body>
</html>